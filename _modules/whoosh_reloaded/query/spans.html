<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>whoosh_reloaded.query.spans &mdash; Whoosh-Reloaded 2.7.4 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Whoosh-Reloaded
          </a>
              <div class="version">
                2.7
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../releases/index.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quick start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">Introduction to Whoosh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../schema.html">Designing a schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../indexing.html">How to index documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../searching.html">How to search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parsing.html">Parsing user queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../querylang.html">The default query language</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dates.html">Indexing and parsing dates/times</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../query.html">Query objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../analysis.html">About analyzers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../stemming.html">Stemming, variations, and accent folding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ngrams.html">Indexing and searching N-grams</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../facets.html">Sorting and faceting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../highlight.html">How to create highlighted search result excerpts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../keywords.html">Query expansion and Key word extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../spelling.html">“Did you mean… ?” Correcting errors in user queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fieldcaches.html">Field caches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../batch.html">Tips for speeding up batch indexing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../threads.html">Concurrency, locking, and versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nested.html">Indexing and searching document hierarchies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../recipes.html">Whoosh recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">Whoosh API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tech/index.html">Technical notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Whoosh-Reloaded</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">whoosh_reloaded.query.spans</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for whoosh_reloaded.query.spans</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2010 Matt Chaput. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without</span>
<span class="c1"># modification, are permitted provided that the following conditions are met:</span>
<span class="c1">#</span>
<span class="c1">#    1. Redistributions of source code must retain the above copyright notice,</span>
<span class="c1">#       this list of conditions and the following disclaimer.</span>
<span class="c1">#</span>
<span class="c1">#    2. Redistributions in binary form must reproduce the above copyright</span>
<span class="c1">#       notice, this list of conditions and the following disclaimer in the</span>
<span class="c1">#       documentation and/or other materials provided with the distribution.</span>
<span class="c1">#</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY MATT CHAPUT ``AS IS&#39;&#39; AND ANY EXPRESS OR</span>
<span class="c1"># IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
<span class="c1"># MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO</span>
<span class="c1"># EVENT SHALL MATT CHAPUT OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<span class="c1"># INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<span class="c1"># LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,</span>
<span class="c1"># OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF</span>
<span class="c1"># LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING</span>
<span class="c1"># NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,</span>
<span class="c1"># EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="c1">#</span>
<span class="c1"># The views and conclusions contained in the software and documentation are</span>
<span class="c1"># those of the authors and should not be interpreted as representing official</span>
<span class="c1"># policies, either expressed or implied, of Matt Chaput.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains Query objects that deal with &quot;spans&quot;.</span>

<span class="sd">Span queries allow for positional constraints on matching documents. For</span>
<span class="sd">example, the :class:`whoosh_reloaded.spans.SpanNear` query matches documents where one</span>
<span class="sd">term occurs near another. Because you can nest span queries, and wrap them</span>
<span class="sd">around almost any non-span query, you can create very complex constraints.</span>

<span class="sd">For example, to find documents containing &quot;whoosh_reloaded&quot; at most 5 positions before</span>
<span class="sd">&quot;library&quot; in the &quot;text&quot; field::</span>

<span class="sd">    from whoosh_reloaded import query, spans</span>
<span class="sd">    t1 = query.Term(&quot;text&quot;, &quot;whoosh_reloaded&quot;)</span>
<span class="sd">    t2 = query.Term(&quot;text&quot;, &quot;library&quot;)</span>
<span class="sd">    q = spans.SpanNear(t1, t2, slop=5)</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">whoosh_reloaded.matching</span> <span class="kn">import</span> <span class="n">mcore</span><span class="p">,</span> <span class="n">wrappers</span><span class="p">,</span> <span class="n">binary</span>
<span class="kn">from</span> <span class="nn">whoosh_reloaded.query</span> <span class="kn">import</span> <span class="n">Query</span><span class="p">,</span> <span class="n">And</span><span class="p">,</span> <span class="n">AndMaybe</span><span class="p">,</span> <span class="n">Or</span><span class="p">,</span> <span class="n">Term</span>
<span class="kn">from</span> <span class="nn">whoosh_reloaded.util</span> <span class="kn">import</span> <span class="n">make_binary_tree</span>


<span class="c1"># Span class</span>


<div class="viewcode-block" id="Span"><a class="viewcode-back" href="../../../api/query.html#whoosh_reloaded.query.Span">[docs]</a><span class="k">class</span> <span class="nc">Span</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;startchar&quot;</span><span class="p">,</span> <span class="s2">&quot;endchar&quot;</span><span class="p">,</span> <span class="s2">&quot;boost&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">startchar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endchar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">boost</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">start</span>
        <span class="k">assert</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startchar</span> <span class="o">=</span> <span class="n">startchar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endchar</span> <span class="o">=</span> <span class="n">endchar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boost</span> <span class="o">=</span> <span class="n">boost</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">startchar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">endchar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2">:</span><span class="si">%d</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">startchar</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">endchar</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">==</span> <span class="n">span</span><span class="o">.</span><span class="n">start</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">==</span> <span class="n">span</span><span class="o">.</span><span class="n">end</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">startchar</span> <span class="o">==</span> <span class="n">span</span><span class="o">.</span><span class="n">startchar</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">endchar</span> <span class="o">==</span> <span class="n">span</span><span class="o">.</span><span class="n">endchar</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">!=</span> <span class="n">span</span><span class="o">.</span><span class="n">start</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">!=</span> <span class="n">span</span><span class="o">.</span><span class="n">end</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">span</span><span class="o">.</span><span class="n">start</span>

    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">span</span><span class="o">.</span><span class="n">start</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">))</span>

<div class="viewcode-block" id="Span.merge"><a class="viewcode-back" href="../../../api/query.html#whoosh_reloaded.query.Span.merge">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spans</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merges overlapping and touches spans in the given list of spans.</span>

<span class="sd">        Note that this modifies the original list.</span>

<span class="sd">        &gt;&gt;&gt; spans = [Span(1,2), Span(3)]</span>
<span class="sd">        &gt;&gt;&gt; Span.merge(spans)</span>
<span class="sd">        &gt;&gt;&gt; spans</span>
<span class="sd">        [&lt;1-3&gt;]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">spans</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">here</span> <span class="o">=</span> <span class="n">spans</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">spans</span><span class="p">):</span>
                <span class="n">there</span> <span class="o">=</span> <span class="n">spans</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">there</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">here</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">here</span><span class="o">.</span><span class="n">touches</span><span class="p">(</span><span class="n">there</span><span class="p">)</span> <span class="ow">or</span> <span class="n">here</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">there</span><span class="p">):</span>
                    <span class="n">here</span> <span class="o">=</span> <span class="n">here</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">there</span><span class="p">)</span>
                    <span class="n">spans</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">here</span>
                    <span class="k">del</span> <span class="n">spans</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">spans</span></div>

    <span class="k">def</span> <span class="nf">to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">startchar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">minchar</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="n">startchar</span>
        <span class="k">elif</span> <span class="n">span</span><span class="o">.</span><span class="n">startchar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">minchar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startchar</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">minchar</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startchar</span><span class="p">,</span> <span class="n">span</span><span class="o">.</span><span class="n">startchar</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">endchar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">maxchar</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="n">endchar</span>
        <span class="k">elif</span> <span class="n">span</span><span class="o">.</span><span class="n">endchar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">maxchar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endchar</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">maxchar</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endchar</span><span class="p">,</span> <span class="n">span</span><span class="o">.</span><span class="n">endchar</span><span class="p">)</span>

        <span class="n">minpos</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">span</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
        <span class="n">maxpos</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">span</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">minpos</span><span class="p">,</span> <span class="n">maxpos</span><span class="p">,</span> <span class="n">minchar</span><span class="p">,</span> <span class="n">maxchar</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">overlaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">span</span><span class="o">.</span><span class="n">start</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">span</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">&gt;=</span> <span class="n">span</span><span class="o">.</span><span class="n">start</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="n">span</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">span</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="ow">and</span> <span class="n">span</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">span</span><span class="o">.</span><span class="n">end</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="ow">and</span> <span class="n">span</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">surrounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">span</span><span class="o">.</span><span class="n">start</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">span</span><span class="o">.</span><span class="n">end</span>

    <span class="k">def</span> <span class="nf">is_within</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">span</span><span class="o">.</span><span class="n">start</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="n">span</span><span class="o">.</span><span class="n">end</span>

    <span class="k">def</span> <span class="nf">is_before</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">span</span><span class="o">.</span><span class="n">start</span>

    <span class="k">def</span> <span class="nf">is_after</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">span</span><span class="o">.</span><span class="n">end</span>

    <span class="k">def</span> <span class="nf">touches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">==</span> <span class="n">span</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">==</span> <span class="n">span</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">distance_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">span</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_before</span><span class="p">(</span><span class="n">span</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">span</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">span</span><span class="o">.</span><span class="n">end</span></div>


<span class="k">def</span> <span class="nf">bisect_spans</span><span class="p">(</span><span class="n">spans</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
    <span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spans</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">lo</span> <span class="o">&lt;</span> <span class="n">hi</span><span class="p">:</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">lo</span> <span class="o">+</span> <span class="n">hi</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">spans</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">:</span>
            <span class="n">lo</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hi</span> <span class="o">=</span> <span class="n">mid</span>
    <span class="k">return</span> <span class="n">lo</span>


<span class="c1"># Base matchers</span>


<span class="k">class</span> <span class="nc">SpanWrappingMatcher</span><span class="p">(</span><span class="n">wrappers</span><span class="o">.</span><span class="n">WrappingMatcher</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An abstract matcher class that wraps a &quot;regular&quot; matcher. This matcher</span>
<span class="sd">    uses the sub-matcher&#39;s matching logic, but only matches documents that have</span>
<span class="sd">    matching spans, i.e. where ``_get_spans()`` returns a non-empty list.</span>

<span class="sd">    Subclasses must implement the ``_get_spans()`` method, which returns a list</span>
<span class="sd">    of valid spans for the current document.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SpanWrappingMatcher</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_find_next</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">m</span><span class="o">.</span><span class="n">_spans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span>
        <span class="k">return</span> <span class="n">m</span>

    <span class="k">def</span> <span class="nf">_replacement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newchild</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">newchild</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_find_next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">child</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">child</span>
        <span class="n">r</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">spans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_spans</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">child</span><span class="o">.</span><span class="n">is_active</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">spans</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">next</span><span class="p">()</span> <span class="ow">or</span> <span class="n">r</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">child</span><span class="o">.</span><span class="n">is_active</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="n">spans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_spans</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span> <span class="o">=</span> <span class="n">spans</span>

        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">spans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spans</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_find_next</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">skip_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child</span><span class="o">.</span><span class="n">skip_to</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_find_next</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">all_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="p">():</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">SpanBiMatcher</span><span class="p">(</span><span class="n">SpanWrappingMatcher</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">depth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">depth</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">depth</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minquality</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c1"># TODO: fix this</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">mcore</span><span class="o">.</span><span class="n">NullMatcher</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>


<span class="c1"># Queries</span>


<div class="viewcode-block" id="SpanQuery"><a class="viewcode-back" href="../../../api/query.html#whoosh_reloaded.query.SpanQuery">[docs]</a><span class="k">class</span> <span class="nc">SpanQuery</span><span class="p">(</span><span class="n">Query</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for span-based queries. Each span query type wraps</span>
<span class="sd">    a &quot;regular&quot; query that implements the basic document-matching functionality</span>
<span class="sd">    (for example, SpanNear wraps an And query, because SpanNear requires that</span>
<span class="sd">    the two sub-queries occur in the same documents. The wrapped query is</span>
<span class="sd">    stored in the ``q`` attribute.</span>

<span class="sd">    Subclasses usually only need to implement the initializer to set the</span>
<span class="sd">    wrapped query, and ``matcher()`` to return a span-aware matcher object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_subm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">matcher</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">other</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">other</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">q</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span> <span class="o">^</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">needs_spans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<span class="k">class</span> <span class="nc">WrappingSpan</span><span class="p">(</span><span class="n">SpanQuery</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">is_leaf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">),</span> <span class="n">limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">field</span><span class="p">()</span>


<div class="viewcode-block" id="SpanFirst"><a class="viewcode-back" href="../../../api/query.html#whoosh_reloaded.query.SpanFirst">[docs]</a><span class="k">class</span> <span class="nc">SpanFirst</span><span class="p">(</span><span class="n">WrappingSpan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matches spans that end within the first N positions. This lets you</span>
<span class="sd">    for example only match terms near the beginning of the document.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param q: the query to match.</span>
<span class="sd">        :param limit: the query must match within this position at the start</span>
<span class="sd">            of a document. The default is ``0``, which means the query must</span>
<span class="sd">            match at the first position.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">q</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">limit</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">other</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">other</span><span class="o">.</span><span class="vm">__class__</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">q</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">limit</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">)</span> <span class="o">^</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">matcher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">searcher</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subm</span><span class="p">(</span><span class="n">searcher</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SpanFirst</span><span class="o">.</span><span class="n">SpanFirstMatcher</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">SpanFirstMatcher</span><span class="p">(</span><span class="n">SpanWrappingMatcher</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">limit</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">SpanFirst</span><span class="o">.</span><span class="n">SpanFirstMatcher</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_replacement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newchild</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">newchild</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_get_spans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">span</span> <span class="k">for</span> <span class="n">span</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child</span><span class="o">.</span><span class="n">spans</span><span class="p">()</span> <span class="k">if</span> <span class="n">span</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">]</span></div>


<div class="viewcode-block" id="SpanNear"><a class="viewcode-back" href="../../../api/query.html#whoosh_reloaded.query.SpanNear">[docs]</a><span class="k">class</span> <span class="nc">SpanNear</span><span class="p">(</span><span class="n">SpanQuery</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Note: for new code, use :class:`SpanNear2` instead of this class. SpanNear2</span>
<span class="sd">    takes a list of sub-queries instead of requiring you to create a binary</span>
<span class="sd">    tree of query objects.</span>

<span class="sd">    Matches queries that occur near each other. By default, only matches</span>
<span class="sd">    queries that occur right next to each other (slop=1) and in order</span>
<span class="sd">    (ordered=True).</span>

<span class="sd">    For example, to find documents where &quot;whoosh_reloaded&quot; occurs next to &quot;library&quot;</span>
<span class="sd">    in the &quot;text&quot; field::</span>

<span class="sd">        from whoosh_reloaded import query, spans</span>
<span class="sd">        t1 = query.Term(&quot;text&quot;, &quot;whoosh_reloaded&quot;)</span>
<span class="sd">        t2 = query.Term(&quot;text&quot;, &quot;library&quot;)</span>
<span class="sd">        q = spans.SpanNear(t1, t2)</span>

<span class="sd">    To find documents where &quot;whoosh_reloaded&quot; occurs at most 5 positions before</span>
<span class="sd">    &quot;library&quot;::</span>

<span class="sd">        q = spans.SpanNear(t1, t2, slop=5)</span>

<span class="sd">    To find documents where &quot;whoosh_reloaded&quot; occurs at most 5 positions before or after</span>
<span class="sd">    &quot;library&quot;::</span>

<span class="sd">        q = spans.SpanNear(t1, t2, slop=5, ordered=False)</span>

<span class="sd">    You can use the ``phrase()`` class method to create a tree of SpanNear</span>
<span class="sd">    queries to match a list of terms::</span>

<span class="sd">        q = spans.SpanNear.phrase(&quot;text&quot;, [&quot;whoosh_reloaded&quot;, &quot;search&quot;, &quot;library&quot;],</span>
<span class="sd">                                  slop=2)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">slop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mindist</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param a: the first query to match.</span>
<span class="sd">        :param b: the second query that must occur within &quot;slop&quot; positions of</span>
<span class="sd">            the first query.</span>
<span class="sd">        :param slop: the number of positions within which the queries must</span>
<span class="sd">            occur. Default is 1, meaning the queries must occur right next</span>
<span class="sd">            to each other.</span>
<span class="sd">        :param ordered: whether a must occur before b. Default is True.</span>
<span class="sd">        :pram mindist: the minimum distance allowed between the queries.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">And</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slop</span> <span class="o">=</span> <span class="n">slop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ordered</span> <span class="o">=</span> <span class="n">ordered</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mindist</span> <span class="o">=</span> <span class="n">mindist</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%r</span><span class="s2">, slop=</span><span class="si">%d</span><span class="s2">, ordered=</span><span class="si">%s</span><span class="s2">, mindist=</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slop</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ordered</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mindist</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">other</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="vm">__class__</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">q</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">slop</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">slop</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordered</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">ordered</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mindist</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">mindist</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
            <span class="o">^</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
            <span class="o">^</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slop</span><span class="p">)</span>
            <span class="o">^</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ordered</span><span class="p">)</span>
            <span class="o">^</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mindist</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_leaf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="n">fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">),</span>
            <span class="n">fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">),</span>
            <span class="n">slop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slop</span><span class="p">,</span>
            <span class="n">ordered</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ordered</span><span class="p">,</span>
            <span class="n">mindist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mindist</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">matcher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">searcher</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">matcher</span><span class="p">(</span><span class="n">searcher</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">mb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">matcher</span><span class="p">(</span><span class="n">searcher</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SpanNear</span><span class="o">.</span><span class="n">SpanNearMatcher</span><span class="p">(</span>
            <span class="n">ma</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="n">slop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slop</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ordered</span><span class="p">,</span> <span class="n">mindist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mindist</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">phrase</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">slop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a tree of SpanNear queries to match a list of terms.</span>

<span class="sd">        This class method is a convenience for constructing a phrase query</span>
<span class="sd">        using a binary tree of SpanNear queries::</span>

<span class="sd">            SpanNear.phrase(&quot;content&quot;, [&quot;alfa&quot;, &quot;bravo&quot;, &quot;charlie&quot;, &quot;delta&quot;])</span>

<span class="sd">        :param fieldname: the name of the field to search in.</span>
<span class="sd">        :param words: a sequence of texts to search for.</span>
<span class="sd">        :param slop: the number of positions within which the terms must</span>
<span class="sd">            occur. Default is 1, meaning the terms must occur right next</span>
<span class="sd">            to each other.</span>
<span class="sd">        :param ordered: whether the terms must occur in order. Default is True.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">terms</span> <span class="o">=</span> <span class="p">[</span><span class="n">Term</span><span class="p">(</span><span class="n">fieldname</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">make_binary_tree</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">terms</span><span class="p">,</span> <span class="n">slop</span><span class="o">=</span><span class="n">slop</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="n">ordered</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">SpanNearMatcher</span><span class="p">(</span><span class="n">SpanWrappingMatcher</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">slop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mindist</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slop</span> <span class="o">=</span> <span class="n">slop</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ordered</span> <span class="o">=</span> <span class="n">ordered</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mindist</span> <span class="o">=</span> <span class="n">mindist</span>
            <span class="n">isect</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">IntersectionMatcher</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">SpanNear</span><span class="o">.</span><span class="n">SpanNearMatcher</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">isect</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                <span class="n">slop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slop</span><span class="p">,</span>
                <span class="n">ordered</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ordered</span><span class="p">,</span>
                <span class="n">mindist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mindist</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minquality</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="c1"># TODO: fix this</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">mcore</span><span class="o">.</span><span class="n">NullMatcher</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">def</span> <span class="nf">_get_spans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">slop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slop</span>
            <span class="n">mindist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mindist</span>
            <span class="n">ordered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordered</span>
            <span class="n">spans</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="n">bspans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">spans</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">aspan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">spans</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">bspan</span> <span class="ow">in</span> <span class="n">bspans</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">bspan</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">aspan</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">slop</span> <span class="ow">or</span> <span class="p">(</span>
                        <span class="n">ordered</span> <span class="ow">and</span> <span class="n">aspan</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">bspan</span><span class="o">.</span><span class="n">start</span>
                    <span class="p">):</span>
                        <span class="c1"># B is too far in front of A, or B is in front of A</span>
                        <span class="c1"># *at all* when ordered is True</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">bspan</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">aspan</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="n">slop</span><span class="p">:</span>
                        <span class="c1"># B is too far from A. Since spans are listed in</span>
                        <span class="c1"># start position order, we know that all spans after</span>
                        <span class="c1"># this one will also be too far.</span>
                        <span class="k">break</span>

                    <span class="c1"># Check the distance between the spans</span>
                    <span class="n">dist</span> <span class="o">=</span> <span class="n">aspan</span><span class="o">.</span><span class="n">distance_to</span><span class="p">(</span><span class="n">bspan</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mindist</span> <span class="o">&lt;=</span> <span class="n">dist</span> <span class="o">&lt;=</span> <span class="n">slop</span><span class="p">:</span>
                        <span class="n">spans</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">aspan</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">bspan</span><span class="p">))</span>

            <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">spans</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpanNear2"><a class="viewcode-back" href="../../../api/query.html#whoosh_reloaded.query.SpanNear2">[docs]</a><span class="k">class</span> <span class="nc">SpanNear2</span><span class="p">(</span><span class="n">SpanQuery</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Matches queries that occur near each other. By default, only matches</span>
<span class="sd">    queries that occur right next to each other (slop=1) and in order</span>
<span class="sd">    (ordered=True).</span>

<span class="sd">    New code should use this query type instead of :class:`SpanNear`.</span>

<span class="sd">    (Unlike :class:`SpanNear`, this query takes a list of subqueries instead of</span>
<span class="sd">    requiring you to build a binary tree of query objects. This query should</span>
<span class="sd">    also be slightly faster due to less overhead.)</span>

<span class="sd">    For example, to find documents where &quot;whoosh_reloaded&quot; occurs next to &quot;library&quot;</span>
<span class="sd">    in the &quot;text&quot; field::</span>

<span class="sd">        from whoosh_reloaded import query, spans</span>
<span class="sd">        t1 = query.Term(&quot;text&quot;, &quot;whoosh_reloaded&quot;)</span>
<span class="sd">        t2 = query.Term(&quot;text&quot;, &quot;library&quot;)</span>
<span class="sd">        q = spans.SpanNear2([t1, t2])</span>

<span class="sd">    To find documents where &quot;whoosh_reloaded&quot; occurs at most 5 positions before</span>
<span class="sd">    &quot;library&quot;::</span>

<span class="sd">        q = spans.SpanNear2([t1, t2], slop=5)</span>

<span class="sd">    To find documents where &quot;whoosh_reloaded&quot; occurs at most 5 positions before or after</span>
<span class="sd">    &quot;library&quot;::</span>

<span class="sd">        q = spans.SpanNear2(t1, t2, slop=5, ordered=False)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qs</span><span class="p">,</span> <span class="n">slop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mindist</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param qs: a sequence of sub-queries to match.</span>
<span class="sd">        :param slop: the number of positions within which the queries must</span>
<span class="sd">            occur. Default is 1, meaning the queries must occur right next</span>
<span class="sd">            to each other.</span>
<span class="sd">        :param ordered: whether a must occur before b. Default is True.</span>
<span class="sd">        :pram mindist: the minimum distance allowed between the queries.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slop</span> <span class="o">=</span> <span class="n">slop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ordered</span> <span class="o">=</span> <span class="n">ordered</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mindist</span> <span class="o">=</span> <span class="n">mindist</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%r</span><span class="s2">, slop=</span><span class="si">%d</span><span class="s2">, ordered=</span><span class="si">%s</span><span class="s2">, mindist=</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qs</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slop</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ordered</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mindist</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">other</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="vm">__class__</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">qs</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">qs</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">slop</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">slop</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordered</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">ordered</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mindist</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">mindist</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slop</span><span class="p">)</span> <span class="o">^</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ordered</span><span class="p">)</span> <span class="o">^</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mindist</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">qs</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">^=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">_and_query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">And</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">estimate_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ixreader</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_and_query</span><span class="p">()</span><span class="o">.</span><span class="n">estimate_size</span><span class="p">(</span><span class="n">ixreader</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">estimate_min_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ixreader</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_and_query</span><span class="p">()</span><span class="o">.</span><span class="n">estimate_min_size</span><span class="p">(</span><span class="n">ixreader</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_leaf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qs</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="p">[</span><span class="n">fn</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">qs</span><span class="p">],</span>
            <span class="n">slop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slop</span><span class="p">,</span>
            <span class="n">ordered</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ordered</span><span class="p">,</span>
            <span class="n">mindist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mindist</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">matcher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">searcher</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ms</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span><span class="o">.</span><span class="n">matcher</span><span class="p">(</span><span class="n">searcher</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">qs</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">SpanNear2Matcher</span><span class="p">(</span>
            <span class="n">ms</span><span class="p">,</span> <span class="n">slop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slop</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ordered</span><span class="p">,</span> <span class="n">mindist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mindist</span>
        <span class="p">)</span>

    <span class="k">class</span> <span class="nc">SpanNear2Matcher</span><span class="p">(</span><span class="n">SpanWrappingMatcher</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">slop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mindist</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ms</span> <span class="o">=</span> <span class="n">ms</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slop</span> <span class="o">=</span> <span class="n">slop</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ordered</span> <span class="o">=</span> <span class="n">ordered</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mindist</span> <span class="o">=</span> <span class="n">mindist</span>
            <span class="n">isect</span> <span class="o">=</span> <span class="n">make_binary_tree</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">IntersectionMatcher</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">SpanNear2</span><span class="o">.</span><span class="n">SpanNear2Matcher</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">isect</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
                <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="p">],</span>
                <span class="n">slop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slop</span><span class="p">,</span>
                <span class="n">ordered</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ordered</span><span class="p">,</span>
                <span class="n">mindist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mindist</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minquality</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="c1"># TODO: fix this</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">mcore</span><span class="o">.</span><span class="n">NullMatcher</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">def</span> <span class="nf">_get_spans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">slop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slop</span>
            <span class="n">mindist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mindist</span>
            <span class="n">ordered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordered</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms</span>

            <span class="n">aspans</span> <span class="o">=</span> <span class="n">ms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spans</span><span class="p">()</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span> <span class="ow">and</span> <span class="n">aspans</span><span class="p">:</span>
                <span class="n">bspans</span> <span class="o">=</span> <span class="n">ms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">spans</span><span class="p">()</span>
                <span class="n">spans</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">aspan</span> <span class="ow">in</span> <span class="n">aspans</span><span class="p">:</span>
                    <span class="c1"># Use a binary search to find the first position we should</span>
                    <span class="c1"># start looking for possible matches</span>
                    <span class="k">if</span> <span class="n">ordered</span><span class="p">:</span>
                        <span class="n">start</span> <span class="o">=</span> <span class="n">aspan</span><span class="o">.</span><span class="n">start</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">aspan</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">slop</span><span class="p">)</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">bisect_spans</span><span class="p">(</span><span class="n">bspans</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>

                    <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">bspans</span><span class="p">):</span>
                        <span class="n">bspan</span> <span class="o">=</span> <span class="n">bspans</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

                        <span class="k">if</span> <span class="n">bspan</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">aspan</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">slop</span> <span class="ow">or</span> <span class="p">(</span>
                            <span class="n">ordered</span> <span class="ow">and</span> <span class="n">aspan</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">bspan</span><span class="o">.</span><span class="n">start</span>
                        <span class="p">):</span>
                            <span class="c1"># B is too far in front of A, or B is in front of A</span>
                            <span class="c1"># *at all* when ordered is True</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">bspan</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">aspan</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="n">slop</span><span class="p">:</span>
                            <span class="c1"># B is too far from A. Since spans are listed in</span>
                            <span class="c1"># start position order, we know that all spans after</span>
                            <span class="c1"># this one will also be too far.</span>
                            <span class="k">break</span>

                        <span class="c1"># Check the distance between the spans</span>
                        <span class="n">dist</span> <span class="o">=</span> <span class="n">aspan</span><span class="o">.</span><span class="n">distance_to</span><span class="p">(</span><span class="n">bspan</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">mindist</span> <span class="o">&lt;=</span> <span class="n">dist</span> <span class="o">&lt;=</span> <span class="n">slop</span><span class="p">:</span>
                            <span class="n">spans</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">aspan</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">bspan</span><span class="p">))</span>
                <span class="n">aspans</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">spans</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">aspans</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="SpanOr"><a class="viewcode-back" href="../../../api/query.html#whoosh_reloaded.query.SpanOr">[docs]</a><span class="k">class</span> <span class="nc">SpanOr</span><span class="p">(</span><span class="n">SpanQuery</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matches documents that match any of a list of sub-queries. Unlike</span>
<span class="sd">    query.Or, this class merges together matching spans from the different</span>
<span class="sd">    sub-queries when they overlap.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subqs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param subqs: a list of queries to match.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">Or</span><span class="p">(</span><span class="n">subqs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subqs</span> <span class="o">=</span> <span class="n">subqs</span>

    <span class="k">def</span> <span class="nf">is_leaf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">([</span><span class="n">fn</span><span class="p">(</span><span class="n">sq</span><span class="p">)</span> <span class="k">for</span> <span class="n">sq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subqs</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">matcher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">searcher</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">matchers</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span><span class="o">.</span><span class="n">matcher</span><span class="p">(</span><span class="n">searcher</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subqs</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">make_binary_tree</span><span class="p">(</span><span class="n">SpanOr</span><span class="o">.</span><span class="n">SpanOrMatcher</span><span class="p">,</span> <span class="n">matchers</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">SpanOrMatcher</span><span class="p">(</span><span class="n">SpanBiMatcher</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>
            <span class="n">um</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">UnionMatcher</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">SpanOr</span><span class="o">.</span><span class="n">SpanOrMatcher</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">um</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_get_spans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">a_active</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">is_active</span><span class="p">()</span>
            <span class="n">b_active</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">is_active</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">a_active</span><span class="p">:</span>
                <span class="n">a_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">b_active</span><span class="p">:</span>
                    <span class="n">b_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">id</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">a_id</span> <span class="o">==</span> <span class="n">b_id</span><span class="p">:</span>
                        <span class="n">spans</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">spans</span><span class="p">())</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">spans</span><span class="p">()))</span>
                    <span class="k">elif</span> <span class="n">a_id</span> <span class="o">&lt;</span> <span class="n">b_id</span><span class="p">:</span>
                        <span class="n">spans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">spans</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">spans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">spans</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">spans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">spans</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">spans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">spans</span><span class="p">()</span>

            <span class="n">Span</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">spans</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">spans</span></div>


<span class="k">class</span> <span class="nc">SpanBiQuery</span><span class="p">(</span><span class="n">SpanQuery</span><span class="p">):</span>
    <span class="c1"># Intermediate base class for methods common to &quot;a/b&quot; span query types</span>

    <span class="k">def</span> <span class="nf">is_leaf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">),</span> <span class="n">fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">matcher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">searcher</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">matcher</span><span class="p">(</span><span class="n">searcher</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">mb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">matcher</span><span class="p">(</span><span class="n">searcher</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Matcher</span><span class="p">(</span><span class="n">ma</span><span class="p">,</span> <span class="n">mb</span><span class="p">)</span>


<div class="viewcode-block" id="SpanNot"><a class="viewcode-back" href="../../../api/query.html#whoosh_reloaded.query.SpanNot">[docs]</a><span class="k">class</span> <span class="nc">SpanNot</span><span class="p">(</span><span class="n">SpanBiQuery</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matches spans from the first query only if they don&#39;t overlap with</span>
<span class="sd">    spans from the second query. If there are no non-overlapping spans, the</span>
<span class="sd">    document does not match.</span>

<span class="sd">    For example, to match documents that contain &quot;bear&quot; at most 2 places after</span>
<span class="sd">    &quot;apple&quot; in the &quot;text&quot; field but don&#39;t have &quot;cute&quot; between them::</span>

<span class="sd">        from whoosh_reloaded import query, spans</span>
<span class="sd">        t1 = query.Term(&quot;text&quot;, &quot;apple&quot;)</span>
<span class="sd">        t2 = query.Term(&quot;text&quot;, &quot;bear&quot;)</span>
<span class="sd">        near = spans.SpanNear(t1, t2, slop=2)</span>
<span class="sd">        q = spans.SpanNot(near, query.Term(&quot;text&quot;, &quot;cute&quot;))</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param a: the query to match.</span>
<span class="sd">        :param b: do not match any spans that overlap with spans from this</span>
<span class="sd">            query.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">AndMaybe</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>

    <span class="k">class</span> <span class="nc">_Matcher</span><span class="p">(</span><span class="n">SpanBiMatcher</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>
            <span class="n">amm</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">AndMaybeMatcher</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">SpanNot</span><span class="o">.</span><span class="n">_Matcher</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">amm</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_get_spans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">id</span><span class="p">():</span>
                <span class="n">spans</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">bspans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">spans</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">aspan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">spans</span><span class="p">():</span>
                    <span class="n">overlapped</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">bspan</span> <span class="ow">in</span> <span class="n">bspans</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">aspan</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">bspan</span><span class="p">):</span>
                            <span class="n">overlapped</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">overlapped</span><span class="p">:</span>
                        <span class="n">spans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aspan</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">spans</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">spans</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpanContains"><a class="viewcode-back" href="../../../api/query.html#whoosh_reloaded.query.SpanContains">[docs]</a><span class="k">class</span> <span class="nc">SpanContains</span><span class="p">(</span><span class="n">SpanBiQuery</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matches documents where the spans of the first query contain any spans</span>
<span class="sd">    of the second query.</span>

<span class="sd">    For example, to match documents where &quot;apple&quot; occurs at most 10 places</span>
<span class="sd">    before &quot;bear&quot; in the &quot;text&quot; field and &quot;cute&quot; is between them::</span>

<span class="sd">        from whoosh_reloaded import query, spans</span>
<span class="sd">        t1 = query.Term(&quot;text&quot;, &quot;apple&quot;)</span>
<span class="sd">        t2 = query.Term(&quot;text&quot;, &quot;bear&quot;)</span>
<span class="sd">        near = spans.SpanNear(t1, t2, slop=10)</span>
<span class="sd">        q = spans.SpanContains(near, query.Term(&quot;text&quot;, &quot;cute&quot;))</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param a: the query to match.</span>
<span class="sd">        :param b: the query whose spans must occur within the matching spans</span>
<span class="sd">            of the first query.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">And</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>

    <span class="k">class</span> <span class="nc">_Matcher</span><span class="p">(</span><span class="n">SpanBiMatcher</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">IntersectionMatcher</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">SpanContains</span><span class="o">.</span><span class="n">_Matcher</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_get_spans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">spans</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">bspans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">spans</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">aspan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">spans</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">bspan</span> <span class="ow">in</span> <span class="n">bspans</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">aspan</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">bspan</span><span class="o">.</span><span class="n">end</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">aspan</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">bspan</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
                        <span class="k">break</span>

                    <span class="k">if</span> <span class="n">bspan</span><span class="o">.</span><span class="n">is_within</span><span class="p">(</span><span class="n">aspan</span><span class="p">):</span>
                        <span class="n">spans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aspan</span><span class="p">)</span>
                        <span class="k">break</span>
            <span class="k">return</span> <span class="n">spans</span></div>


<div class="viewcode-block" id="SpanBefore"><a class="viewcode-back" href="../../../api/query.html#whoosh_reloaded.query.SpanBefore">[docs]</a><span class="k">class</span> <span class="nc">SpanBefore</span><span class="p">(</span><span class="n">SpanBiQuery</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matches documents where the spans of the first query occur before any</span>
<span class="sd">    spans of the second query.</span>

<span class="sd">    For example, to match documents where &quot;apple&quot; occurs anywhere before</span>
<span class="sd">    &quot;bear&quot;::</span>

<span class="sd">        from whoosh_reloaded import query, spans</span>
<span class="sd">        t1 = query.Term(&quot;text&quot;, &quot;apple&quot;)</span>
<span class="sd">        t2 = query.Term(&quot;text&quot;, &quot;bear&quot;)</span>
<span class="sd">        q = spans.SpanBefore(t1, t2)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param a: the query that must occur before the second.</span>
<span class="sd">        :param b: the query that must occur after the first.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">And</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>

    <span class="k">class</span> <span class="nc">_Matcher</span><span class="p">(</span><span class="n">SpanBiMatcher</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">IntersectionMatcher</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">SpanBefore</span><span class="o">.</span><span class="n">_Matcher</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_get_spans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">bminstart</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bspan</span><span class="o">.</span><span class="n">start</span> <span class="k">for</span> <span class="n">bspan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">spans</span><span class="p">())</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">aspan</span> <span class="k">for</span> <span class="n">aspan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">spans</span><span class="p">()</span> <span class="k">if</span> <span class="n">aspan</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">bminstart</span><span class="p">]</span></div>


<div class="viewcode-block" id="SpanCondition"><a class="viewcode-back" href="../../../api/query.html#whoosh_reloaded.query.SpanCondition">[docs]</a><span class="k">class</span> <span class="nc">SpanCondition</span><span class="p">(</span><span class="n">SpanBiQuery</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matches documents that satisfy both subqueries, but only uses the spans</span>
<span class="sd">    from the first subquery.</span>

<span class="sd">    This is useful when you want to place conditions on matches but not have</span>
<span class="sd">    those conditions affect the spans returned.</span>

<span class="sd">    For example, to get spans for the term ``alfa`` in documents that also</span>
<span class="sd">    must contain the term ``bravo``::</span>

<span class="sd">        SpanCondition(Term(&quot;text&quot;, u&quot;alfa&quot;), Term(&quot;text&quot;, u&quot;bravo&quot;))</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">And</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>

    <span class="k">class</span> <span class="nc">_Matcher</span><span class="p">(</span><span class="n">SpanBiMatcher</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">IntersectionMatcher</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">SpanCondition</span><span class="o">.</span><span class="n">_Matcher</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_get_spans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">spans</span><span class="p">()</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2007-2012 Matt Chaput.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>